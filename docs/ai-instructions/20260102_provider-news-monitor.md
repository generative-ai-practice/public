# プロバイダーニュース監視システム - 実装計画

**更新日:** 2026-01-02
**目的:** AIプロバイダーのニュース/リリースノートページを監視し、新着記事の要約を生成する

## 目標

### 第一目標（現在の実装範囲）

Anthropicのニュースページとリリースノートページを監視し、**新着記事**を検出して要約を生成・保存する。

**重要:** これは包括的なモデル情報抽出システムではなく、シンプルなニュース監視ツールである。

### 今後の実装計画

**Phase 2: 複数プロバイダー対応**

- ニュース監視対象を `provider2agent.ts` と揃える
  - OpenAI（GPTシリーズ）
  - Anthropic（Claudeシリーズ）
  - Google / Gemini
  - Groq
  - Replicate
  - ElevenLabs
  - Nijivoice
  - Kotodama
  - Mock（テスト用）
- 各プロバイダー用のProvider実装追加
- プロバイダー別の記事要約生成

**Phase 3: モデル情報の抽出と追跡**

- 要約から新モデル情報を抽出
- モデル名、リリース日、主な特徴をJSON化
- 既存モデルリストとの差分検出
- MulmoCast の `provider2agent.ts` 更新の必要性を判定

**Phase 4: 自動更新フロー**

- 新モデル検出時に `provider2agent.ts` の更新内容を生成
- プルリクエスト自動作成（GitHub Actions連携）
- 変更内容のレビュー用レポート生成

**Phase 5: 通知・自動化**

- 新着記事検出時のSlack/Email通知
- 定期実行（cron, GitHub Actions）
- 要約の自動翻訳（英→日）

## 実装言語

**TypeScript** - 全ファイル `.ts` 拡張子

## 本システムが行うこと

- ニュース/リリースノートページの新着記事を監視
- 前回チェック時との比較による新着記事の検出
- 新着記事のHTML取得
- Geminiによる記事要約の生成
- 要約をMarkdownファイルとして保存

## 本システムが行わないこと

- ❌ ドキュメントから全モデル情報を抽出
- ❌ 価格ページの取得
- ❌ 複雑なモデルJSONファイルの作成
- ❌ 要約に「モデル変更」セクションを含める
- ❌ 要約内でモデルの非推奨/更新を追跡

## データソース

**URL はプロバイダー設定テーブルで管理（別途定義）**

1. **Anthropic News:** https://www.anthropic.com/news
2. **Claude Release Notes:** https://platform.claude.com/docs/en/release-notes/overview
3. **その他プロバイダー:** 設定テーブルに source 種別（news / release-notes / blog）と URL を追加して運用

## アーキテクチャ

### ニュース監視フロー

1. ニュース/リリースノート一覧ページを取得
2. Geminiで記事リストを抽出（タイトル、日付、URL）
3. `latest.json` と比較
4. 新着記事が見つかった場合：
   - 記事ページのHTMLを取得
   - Geminiで要約を生成
   - Markdownとして保存
5. `latest.json` を更新

### 設計方針

**差分検出アプローチ:**

- 毎回全記事を処理するのではなく、前回チェック時の記事リスト（`latest.json`）と比較
- 新規追加された記事のみを処理対象とする
- 初回実行時は `latest.json` が存在しないため、全記事が「新着」として扱われる
- URLをユニークキーとして記事の同一性を判定

**プロバイダー設定テーブル化:**

- `providers` テーブル（例: JSON/TSマップ）に `provider`, `sources[{type,url}]`, `slugRule?`, `language`, `summaryLanguage` を集約
- Fetcher は設定テーブルを読み、共通フローで `extractArticleList → compare → fetch html → summarize` を実行
- 特殊処理はオプション関数（例: `slugRule` や `transform`）で差し込む

例（イメージ、設定ファイル側に記述）:

```ts
const providers = [
  {
    provider: 'anthropic',
    enabled: true,
    language: 'en',
    summaryLanguage: 'ja',
    sources: [
      { type: 'news', url: 'https://www.anthropic.com/news' },
      {
        type: 'release-notes',
        url: 'https://platform.claude.com/docs/en/release-notes/overview',
      },
    ],
    // slugRule?: (title, publishedDate) => string,
    // transform?: (article) => article,
  },
  // ここに OpenAI / Google / Groq / Replicate / ElevenLabs / Nijivoice / Kotodama / Mock を追加
];
```

**Gemini SDKの活用:**

- **記事リスト抽出:** HTMLから記事のメタデータ（タイトル、URL、日付）をJSON形式で抽出
- **要約生成:** 記事HTMLから人間が読みやすいMarkdown要約を生成（出力言語は日本語を明示）
- **レート制限対策:** 2秒固定遅延 + 429エラー時の指数バックオフ（最大3回リトライ）
- **要約言語:** 出力は日本語に統一（英語記事も翻訳して要約）

**データ永続化:**

- **latest.json:** 記事リスト追跡用。次回実行時の差分検出に使用
- **raw/\*.html:** 記事HTML。参照用に保存（再処理や確認時に使用可能）
- **summaries/\*.md:** 生成された要約。人間が読むメイン成果物

## ディレクトリ構造

```
output/provider-news/{provider}/
├── latest.json              # 前回チェック時の記事リスト（差分検出用）
├── raw/
│   └── article-{slug}.html  # 記事HTML（参照用）
└── summaries/
    └── article-{slug}.md    # 記事要約（Markdown）
```

**ファイル命名規則:**

- `{slug}`: `yyyymmdd-{title-slug}` を推奨（例: `20260102-introducing-claude-4-5`）
  - `title-slug` は記事タイトルを URL セーフにしたもの
    - 小文字化
    - スペースをハイフンに変換
    - 英数字以外を削除
    - 連続ハイフンを単一化
    - 先頭・末尾のハイフンを削除
    - 最大50文字に制限（タイトル部分）
  - `yyyymmdd` は公開日（不明な場合は取得日を使用。取得日も不明なら日付プレフィックスなし）

## 要約フォーマット

生成される要約は以下の形式：

```markdown
# 記事タイトル

**Published:** YYYY-MM-DD
**URL:** https://...
**Source:** news | release-notes
**Language:** ja

## Summary

記事内容の簡潔な要約（2-3段落）

## Key Points

- 重要なポイント1
- 重要なポイント2
- 重要なポイント3

---

_Generated by Provider News Monitor using Gemini 2.5 Flash_
```

## 実装ステップ

### 1. 型定義の更新

**ファイル:** `scripts/types/provider-info.ts`

**既存の型を削除:**

- `ModelInfo` - モデル情報（不要）
- `ProcessedProviderData` - 処理済みデータ（不要）
- `ExtractedPricing` - 価格情報（不要）
- `PricingModel` - 価格モデル（不要）

**新規型を追加:**

- `Article`: 記事メタデータ
  - title, slug, url, publishedDate, source
- `ArticleList`: 記事リスト追跡用
  - provider, lastChecked, articles
- `ExtractedArticles`: Gemini抽出結果
  - fetchedAt, source, extractedBy, data

**既存の型を保持:**

- `RateLimiterConfig`: レート制限設定（そのまま使用）

**設計意図:**

- 記事の一意識別には `slug` を使用（ファイル名として安全）
- URLは記事の同一性判定に使用（前回リストとの比較）
- `source` フィールドで記事の出所を追跡（news vs release-notes）

### 2. Gemini Extractorの更新

**ファイル:** `scripts/lib/gemini-extractor.ts`

**削除するメソッド:**

- `extractPricingFromHTML()` - 価格抽出は不要

**既存メソッドの保持:**

- `extractStructuredData()` - 汎用的なので保持（ただし使用しない可能性あり）

**新規追加メソッド:**

**`extractArticleList(html: string, source: string)`**

- 一覧ページから記事リストをJSON抽出
- JSON mode (`responseMimeType: 'application/json'`) で構造化データを要求
- プロンプトで期待するJSONスキーマを明示
- レート制限を考慮して `rateLimiter.withRetry()` でラップ
- 戻り値: `ExtractedArticles` 型

**`generateArticleSummary(html: string, title: string, url: string, publishedDate: string, source: string)`**

- 記事HTMLからMarkdown要約を生成
- テキストモード（JSON modeではない）でMarkdown生成
- プロンプトに完全なフォーマットテンプレートを含める
- 記事メタデータ（title, date, URL, source）を明示的に渡す
- 2-3段落の要約 + 箇条書きのKey Pointsを要求
- レート制限を考慮して `rateLimiter.withRetry()` でラップ
- 戻り値: Markdown文字列

### 3. Anthropic Providerの完全書き換え

**ファイル:** `scripts/lib/provider-fetchers/anthropic-provider.ts`

**現在の実装を完全削除:**

- 全モデル抽出ロジック
- 価格ページ取得
- Deprecationsページ取得
- 複雑なモデルマージ処理
- `generateModelId()`, `generateAgentName()`, `parsePricingFromExtracted()` などの補助メソッド

**新規実装:**

**プロパティ:**

- `newsUrl`: Anthropicニュースページ
- `releaseNotesUrl`: リリースノートページ
- `geminiExtractor`: GeminiExtractor インスタンス
- `timestamp`: 実行時のタイムスタンプ
- `currentArticles`: 現在取得した記事リスト
- `previousArticles`: 前回チェック時の記事リスト

**主要メソッド:**

**`fetchRawData()`**

1. ニュースページ一覧を取得（fetch）
2. リリースノートページ一覧を取得（fetch）
3. 各ページからGeminiで記事リストを抽出（`extractArticleList`）
4. 抽出結果を統合して `currentArticles` に格納

**`processData()`**

1. `latest.json` を読み込み（`loadLatestArticles()`）
   - 存在しない場合は空リストとして扱う
2. 現在の記事リストと前回リストを比較（`compareArticles()`）
   - URLをキーとして比較
3. 新着記事を特定
4. 各新着記事について並列処理：
   - 記事ページのHTMLを取得
   - Geminiで要約を生成（`generateArticleSummary`）
   - `summaries/{slug}.md` として保存
   - `raw/{slug}.html` に元HTMLを保存
5. 更新された記事リストを `latest.json` に保存（`saveLatestArticles()`）

**`generateReport()`**

- 新着記事数と処理結果の簡易レポートを生成
- 各記事のタイトル、URL、保存先パスを含める
- コンソールに表示用（ファイル保存は任意）

**補助メソッド:**

- `fetchArticleList(url: string, source: string)`: URLから記事リスト取得・抽出
- `loadLatestArticles()`: latest.json読み込み、存在しない場合は空配列
- `compareArticles(current: Article[], previous: Article[])`: 差分検出（URLで比較）
- `fetchAndSummarize(article: Article)`: 個別記事の取得・要約生成
- `saveLatestArticles(articles: Article[])`: latest.json更新

**設計上の注意点:**

- 初回実行時は全記事が「新着」として扱われる（latest.json不在）
- エラーハンドリング：一部記事の処理失敗でも他の記事は処理継続
- 処理順序：ニュースページ → リリースノートページの順で処理
- 同じ記事が両方に含まれる可能性を考慮（URLで重複排除）

### 4. メインスクリプトの簡素化

**ファイル:** `scripts/fetch-provider-info.ts`

**現在の複雑なオーケストレーションを簡素化:**

**主要フロー:**

1. CLIパラメータ解析
   - `--provider=anthropic` （現時点では anthropic のみ対応）
   - `--dry-run` （書き込みスキップ）
2. 環境変数検証
   - `GEMINI_API_KEY` の存在確認
3. コンポーネント初期化：
   - RateLimiter（delayMs: 2000, maxRetries: 3）
   - GeminiExtractor（apiKey, rateLimiter）
   - AnthropicProvider（geminiExtractor）
4. `provider.run()` 実行
   - BaseProviderの `run()` メソッドを使用
   - fetchRawData → processData → generateReport の順で実行
5. 結果レポート表示

**dry-runモードの動作:**

- ファイル書き込みをスキップ
- API呼び出しは実行（記事リスト取得と要約生成）
- 検出される新着記事数と要約内容をコンソールに表示
- 実際の書き込みは行わない

**エラーハンドリング:**

- APIキー不在時は分かりやすいエラーメッセージ
- ネットワークエラー時は詳細を表示
- 一部処理失敗でも全体は継続

### 5. Storage Utilitiesの拡張

**ファイル:** `scripts/lib/storage.ts`

**既存機能（保持）:**

- `ensureDir()`: ディレクトリ作成
- `saveJSON()`: JSON保存
- `saveText()`: テキスト保存
- `loadJSON()`: JSON読み込み（ファイル不在時は null 返却）
- `buildOutputPath()`: パス構築
- `generateTimestamp()`: タイムスタンプ生成

**新規追加:**

**`generateSlug(title: string, publishedDate?: string): string`**
記事タイトルと公開日からURLセーフなslugを生成（`yyyymmdd-title-slug` 推奨）

処理内容：

1. タイトルを小文字変換（`.toLowerCase()`）
2. 英数字以外をハイフンに変換（`/[^a-z0-9]+/g` → `-`）
3. 連続ハイフンを単一化（`/-+/g` → `-`）
4. 先頭・末尾のハイフンを削除（`/^-+|-+$/g` → ``）
5. 最大50文字に制限（`.substring(0, 50)`）
6. `publishedDate` が `YYYY-MM-DD` 形式なら `yyyymmdd-` を先頭に付与。なければ先頭なし。

例：

- "Introducing Claude 4.5", 2026-01-02 → "20260102-introducing-claude-4-5"
- "Release Notes: January 2026!", 2026-01-01 → "20260101-release-notes-january-2026"

### 6. Base Provider（変更なし）

**ファイル:** `scripts/lib/provider-fetchers/base-provider.ts`

現在の実装をそのまま使用。

**既存の `run()` メソッド:**

```
async run() {
  await this.fetchRawData();
  await this.processData();
  await this.generateReport();
}
```

このフローは新しい設計でもそのまま適用可能。

### 7. Rate Limiter（変更なし）

**ファイル:** `scripts/lib/rate-limiter.ts`

現在の実装で問題なし。保持する。

**主要機能:**

- 固定遅延（デフォルト2秒）
- 429エラー検出と自動リトライ
- 指数バックオフ（2倍ずつ増加、最大30秒）
- コール数追跡

### 8. Package.json（変更なし）

既存のスクリプト定義を使用:

- `yarn fetch:providers --provider=anthropic`
- `yarn fetch:providers:dry-run --provider=anthropic`

## テスト手順

```bash
# 1. ドライラン（書き込みなし、動作確認）
yarn fetch:providers:dry-run --provider=anthropic

# 2. 初回実行（全記事が新着として処理される）
yarn fetch:providers --provider=anthropic

# 3. 出力確認
ls -la output/provider-news/anthropic/
cat output/provider-news/anthropic/latest.json
cat output/provider-news/anthropic/summaries/*.md

# 4. 2回目実行（新着記事のみ処理される）
yarn fetch:providers --provider=anthropic
# → 「新着記事なし」と表示されるはず

# 5. 数日後に再実行（新記事公開後）
yarn fetch:providers --provider=anthropic
# → 新記事のみが処理される
```

**期待される動作:**

1. 初回: 全記事の要約が生成される（例: 10記事）
2. 2回目: 「新着記事なし」と表示される
3. 新記事公開後: その記事のみが処理される（例: 1記事）

**確認ポイント:**

- `latest.json` に記事リストが正しく保存されているか
- `summaries/*.md` に要約が生成されているか
- 要約フォーマットが正しいか
- 2回目実行時に重複処理されないか

## 期待される出力例

### latest.json

```json
{
  "provider": "anthropic",
  "lastChecked": "2026-01-02T10:30:00.000Z",
  "articles": [
    {
      "title": "Introducing Claude 4.5",
      "slug": "introducing-claude-4-5",
      "url": "https://www.anthropic.com/news/claude-4-5",
      "publishedDate": "2026-01-02",
      "source": "news"
    },
    {
      "title": "January 2026 Release Notes",
      "slug": "january-2026-release-notes",
      "url": "https://platform.claude.com/docs/en/release-notes/2026-01",
      "publishedDate": "2026-01-01",
      "source": "release-notes"
    }
  ]
}
```

### summaries/introducing-claude-4-5.md（サンプル、日本語要約）

```markdown
# Introducing Claude 4.5

**Published:** 2026-01-02
**URL:** https://www.anthropic.com/news/claude-4-5
**Source:** news
**Language:** ja

## Summary

Claude 4.5 は既存の Claude モデルを拡張し、推論力と文脈保持性能を強化したアップデート版。大規模な情報を扱う際の精度を維持しつつ、応答速度も改善されている。安全性の強化により、Anthropic の責任ある AI 開発方針に沿った形で提供される。

## Key Points

- 複雑な分析タスクでの推論性能が向上
- 大きな文脈を保持しつつ精度を確保
- 全エンドポイントで応答速度が改善
- 安全性とアラインメントを強化
- 既存 Claude API との後方互換性を維持

---

_Generated by Provider News Monitor using Gemini 2.5 Flash_
```

## 修正対象ファイル一覧

### 既存ファイルの修正

1. **scripts/types/provider-info.ts**
   - 削除: `ModelInfo`, `ProcessedProviderData`, `ExtractedPricing`, `PricingModel`
   - 追加: `Article`, `ArticleList`, `ExtractedArticles`
   - 保持: `RateLimiterConfig`

2. **scripts/lib/gemini-extractor.ts**
   - 削除: `extractPricingFromHTML()`
   - 追加: `extractArticleList()`, `generateArticleSummary()`
   - 保持: `extractStructuredData()` (オプション)

3. **scripts/lib/provider-fetchers/anthropic-provider.ts**
   - 完全書き換え
   - 新規: 記事監視・要約生成ロジック

4. **scripts/fetch-provider-info.ts**
   - 簡素化（大きな変更は不要、既存フローで動作）

5. **scripts/lib/storage.ts**
   - 追加: `generateSlug()` 関数

### 変更不要ファイル

- **scripts/lib/rate-limiter.ts** - 既存実装で問題なし
- **scripts/lib/provider-fetchers/base-provider.ts** - インターフェース変更なし
- **package.json** - スクリプト定義済み

## 実装順序の推奨

1. **型定義** (`scripts/types/provider-info.ts`) - 基盤となる型を先に定義
2. **Storage拡張** (`scripts/lib/storage.ts`) - `generateSlug()` 追加
3. **Gemini Extractor更新** (`scripts/lib/gemini-extractor.ts`) - 新メソッド追加
4. **Anthropic Provider書き換え** (`scripts/lib/provider-fetchers/anthropic-provider.ts`) - メインロジック
5. **動作確認** - dry-runで動作テスト
6. **本番実行** - 実際に要約生成

## 将来の拡張可能性

1. **複数プロバイダー対応**
   - OpenAI, Google, Mistral等の追加
   - BaseProviderを継承して各プロバイダー実装

2. **通知機能**
   - 新着記事検出時にSlack/Email通知
   - Webhook経由で外部サービスと連携

3. **要約の自動翻訳**
   - 英語記事 → 日本語要約
   - 既存の翻訳スクリプトと連携

4. **RSSフィード生成**
   - 要約をRSS/Atom形式で配信
   - 定期実行でフィード更新

5. **記事アーカイブ**
   - 古い記事の自動アーカイブ
   - 年月別ディレクトリ整理

6. **差分レポート**
   - 前回実行との比較レポート
   - 新着記事数の推移グラフ

## 参考実装

- **Gemini SDK使用例:** `scripts/lib/gemini-extractor.ts` (既存)
- **API取得パターン:** `scripts/fetch-x-thread.ts`
- **レート制限実装:** `scripts/lib/rate-limiter.ts`
- **ファイルI/O:** `scripts/lib/storage.ts`

## 注意事項

- **初回実行はコスト高:** 全記事を処理するため、Gemini APIコールが多くなる
- **レート制限:** 2秒遅延で実行するため、記事数が多い場合は時間がかかる
- **HTMLパース:** Geminiが正確にHTMLを解析できない場合があるため、結果の検証が必要
- **要約品質:** Gemini 2.5 Flashの要約品質に依存。必要に応じてプロンプト調整

---

_本計画は従来の `20260102_provider-info-collector.md` を完全に置き換えるものです_
